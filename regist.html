<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียนพนักงาน</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <?!= include('CSS'); ?>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
            <h1 class="text-xl font-bold text-white text-center">ลงทะเบียน</h1>
        </div>

        <div class="p-6 space-y-6">
            <form id="registrationForm" class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700" for="employeeId">
                        รหัสพนักงาน
                    </label>
                    <div class="flex gap-3">
                        <input type="text" id="employeeId" class="w-1/2 form-input block px-4 py-3 rounded-lg border border-gray-300">
                        <button type="button" onclick="verifyEmployee()" id="verifyButton" class="w-1/2 px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-lg">
                            ตรวจสอบ
                        </button>
                    </div>
                </div>

                <div id="errorMessage" class="hidden p-4 rounded-lg bg-red-50 text-red-600 text-sm"></div>

                <div id="employeeDetails" class="hidden space-y-4">
                    <!-- Employee details fields -->
                </div>
            </form>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // JavaScript.html
let isLoading = false;

async function initializeLIFF() {
  try {
    await liff.init({ liffId: "2006809014-zqJWBVbA" });
    if (!liff.isLoggedIn()) {
      liff.login();
    }
  } catch (err) {
    showError('LIFF initialization failed');
  }
}

window.onload = initializeLIFF;

function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.classList.remove('hidden');
  setTimeout(() => errorDiv.classList.add('hidden'), 3000);
}

function setLoadingState(button, isLoading, loadingText = 'กำลังตรวจสอบ...', defaultText = 'ตรวจสอบ') {
  button.innerHTML = isLoading ? 
    `<div class="spinner"></div>${loadingText}` : 
    defaultText;
  button.disabled = isLoading;
}

async function verifyEmployee() {
  if (isLoading) return;
  
  const employeeId = document.getElementById('employeeId').value;
  const verifyButton = document.getElementById('verifyButton');
  
  if (!employeeId) {
    showError('กรุณากรอกรหัสพนักงาน');
    return;
  }

  isLoading = true;
  setLoadingState(verifyButton, true);

  try {
    const result = await google.script.run.verifyEmployee(employeeId);
    if (result.found) {
      displayEmployeeDetails(result.data);
    } else {
      showError('ไม่พบข้อมูลพนักงาน');
    }
  } catch (error) {
    showError('เกิดข้อผิดพลาดในการตรวจสอบ');
  } finally {
    isLoading = false;
    setLoadingState(verifyButton, false);
  }
}

async function submitRegistration() {
  if (!liff.isLoggedIn()) {
    showError('กรุณาเข้าสู่ระบบ LINE');
    return;
  }

  const submitButton = document.getElementById('submitButton');
  setLoadingState(submitButton, true, 'กำลังดำเนินการ...', 'ลงทะเบียน');

  try {
    const profile = await liff.getProfile();
    const employeeId = document.getElementById('employeeId').value;
    const result = await google.script.run.registerEmployee(employeeId, profile.userId);
    
    if (result) {
      alert('ลงทะเบียนสำเร็จ!');
      liff.closeWindow();
    } else {
      showError('เกิดข้อผิดพลาดในการลงทะเบียน');
    }
  } catch (error) {
    showError('เกิดข้อผิดพลาดในการลงทะเบียน');
  } finally {
    setLoadingState(submitButton, false);
  }
}

function displayEmployeeDetails(data) {
  const detailsDiv = document.getElementById('employeeDetails');
  detailsDiv.innerHTML = `
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700">ชื่อพนักงาน</label>
      <input type="text" value="${data.name} ${data.lastName}" class="block w-full px-4 py-3 rounded-lg border border-gray-300" disabled>
    </div>
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
      <input type="text" value="${data.position}" class="block w-full px-4 py-3 rounded-lg border border-gray-300" disabled>
    </div>
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700">โรงงาน</label>
      <input type="text" value="${data.factory}" class="block w-full px-4 py-3 rounded-lg border border-gray-300" disabled>
    </div>
    <button type="button" onclick="submitRegistration()" id="submitButton" 
      class="w-full px-6 py-3 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700">
      ลงทะเบียน
    </button>
  `;
  
  detailsDiv.classList.remove('hidden');
  document.getElementById('employeeId').disabled = true;
  document.getElementById('verifyButton').style.display = 'none';
}
        </script>
</body>
</html>
