<!DOCTYPE html>
<html lang="th">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ลงทะเบียนพนักงาน</title>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
   <style>
       body {
           background: linear-gradient(135deg, #f6f8fb 0%, #e9eef5 100%);
       }
       .spinner {
           border: 3px solid #f3f3f3;
           border-top: 3px solid #3498db;
           border-radius: 50%;
           width: 20px;
           height: 20px;
           animation: spin 1s linear infinite;
           display: inline-block;
           margin-right: 8px;
       }
       @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }
       .loading {
           display: flex;
           align-items: center;
           justify-content: center;
           padding: 1rem;
       }
   </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
   <div class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
       <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
           <h1 class="text-xl font-bold text-white text-center">ลงทะเบียนพนักงาน</h1>
       </div>

       <div class="p-6 space-y-6">
           <form id="registrationForm" class="space-y-4">
               <div class="space-y-2">
                   <label class="block text-sm font-medium text-gray-700" for="employeeId">
                       รหัสพนักงาน
                   </label>
                   <div class="flex gap-3">
                       <input type="text" id="employeeId" class="w-1/2 form-input block px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-900">
                       <button type="button" onclick="verifyEmployee()" id="verifyButton" 
                           class="w-1/2 px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                           ตรวจสอบ
                       </button>
                   </div>
               </div>

               <div id="loading" class="loading hidden">
                   <div class="spinner"></div>
                   <span>กำลังตรวจสอบ...</span>
               </div>

               <div id="errorMessage" class="hidden p-4 rounded-lg bg-red-50 text-red-600 text-sm"></div>

               <div id="employeeDetails" class="hidden space-y-4"></div>
           </form>
       </div>
   </div>

   <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
   <script>
       let isLoading = false;
       const API_URL = "https://script.google.com/macros/s/AKfycbxXekWmewemj9UWCGJ_3v2bjTE9DfjI5Wwmi_FAt1CPcaau-WMB_bG2fdStdxM35_xq/exec";

       async function initializeLIFF() {
           try {
               await liff.init({ liffId: "2006809014-zqJWBVbA" });
               if (!liff.isLoggedIn()) {
                   liff.login();
               }
           } catch (err) {
               showError('LIFF initialization failed');
           }
       }

       window.onload = initializeLIFF;

       function showError(message) {
           const errorDiv = document.getElementById('errorMessage');
           errorDiv.textContent = message;
           errorDiv.classList.remove('hidden');
           setTimeout(() => errorDiv.classList.add('hidden'), 3000);
       }

       function setLoadingState(button, isLoading) {
           button.disabled = isLoading;
           if (isLoading) {
               button.innerHTML = '<div class="spinner"></div>กำลังตรวจสอบ...';
           } else {
               button.textContent = 'ตรวจสอบ';
           }
       }

       async function verifyEmployee() {
           if (isLoading) return;

           const employeeId = document.getElementById('employeeId').value;
           const verifyButton = document.getElementById('verifyButton');
           const loadingElement = document.getElementById('loading');

           if (!employeeId) {
               showError('กรุณากรอกรหัสพนักงาน');
               return;
           }

           isLoading = true;
           loadingElement.classList.remove('hidden');
           setLoadingState(verifyButton, true);

           try {
               const response = await fetch(`${API_URL}?action=verify&empId=${employeeId}`);
               const result = await response.json();

               if (result.found) {
                   displayEmployeeDetails(result.data);
               } else {
                   showError('ไม่พบข้อมูลพนักงาน');
               }
           } catch (error) {
               showError('เกิดข้อผิดพลาดในการตรวจสอบ');
           } finally {
               isLoading = false;
               loadingElement.classList.add('hidden');
               setLoadingState(verifyButton, false);
           }
       }

       async function submitRegistration() {
           if (!liff.isLoggedIn()) {
               showError('กรุณาเข้าสู่ระบบ LINE');
               return;
           }

           const submitButton = document.getElementById('submitButton');
           const employeeId = document.getElementById('employeeId').value;
           setLoadingState(submitButton, true);

           try {
               const profile = await liff.getProfile();
               const response = await fetch(`${API_URL}?action=register&empId=${employeeId}&uid=${profile.userId}`);
               const result = await response.json();

               if (result.success) {
                   alert('ลงทะเบียนสำเร็จ!');
                   liff.closeWindow();
               } else {
                   showError('เกิดข้อผิดพลาดในการลงทะเบียน');
               }
           } catch (error) {
               showError('เกิดข้อผิดพลาดในการลงทะเบียน');
           } finally {
               setLoadingState(submitButton, false);
           }
       }

       function displayEmployeeDetails(data) {
           const detailsDiv = document.getElementById('employeeDetails');
           detailsDiv.innerHTML = `
               <div class="space-y-2">
                   <label class="block text-sm font-medium text-gray-700">ชื่อพนักงาน</label>
                   <input type="text" value="${data.name} ${data.lastName}" class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50" disabled>
               </div>
               <div class="space-y-2">
                   <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                   <input type="text" value="${data.position}" class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50" disabled>
               </div>
               <div class="space-y-2">
                   <label class="block text-sm font-medium text-gray-700">โรงงาน</label>
                   <input type="text" value="${data.factory}" class="block w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50" disabled>
               </div>
               <button type="button" onclick="submitRegistration()" id="submitButton" 
                   class="w-full px-6 py-3 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out mt-4">
                   ลงทะเบียน
               </button>
           `;

           detailsDiv.classList.remove('hidden');
           document.getElementById('employeeId').disabled = true;
           document.getElementById('verifyButton').style.display = 'none';
       }
   </script>
</body>
</html>
